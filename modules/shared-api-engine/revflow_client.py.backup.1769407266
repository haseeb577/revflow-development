"""
RevFlow Universal Client
Supports both gateway and direct module communication
Implements dual-mode pattern: gateway first, fallback to direct
"""
import requests
import os
from typing import Optional, Dict, Any
import logging

logger = logging.getLogger(__name__)

class RevFlowClient:
    """
    Universal client for RevFlow module communication
    
    Supports two modes:
    1. Gateway mode: Routes through RevCore (recommended)
    2. Direct mode: Direct HTTP calls to modules (legacy)
    
    Features automatic fallback from gateway to direct if gateway fails.
    """
    
    def __init__(self):
        # Gateway endpoint
        self.gateway = os.getenv("REVCORE_GATEWAY", "http://localhost:8004/api/gateway")
        self.use_gateway = os.getenv("USE_REVCORE_GATEWAY", "true").lower() == "true"
        
        # Legacy direct endpoints (fallback)
        self.direct_endpoints = {
            "revprompt": os.getenv("REVPROMPT_API", "http://localhost:8700/api"),
            "revscore": os.getenv("REVSCORE_API", "http://localhost:8100/api"),
            "revrank": os.getenv("REVRANK_API", "http://localhost:8103/api"),
            "revseo": os.getenv("REVSEO_API", "http://localhost:8765/api"),
            "revcite": os.getenv("REVCITE_API", "http://localhost:8900/api"),
            "revhumanize": os.getenv("REVHUMANIZE_API", "http://localhost:8500/api"),
            "revwins": os.getenv("REVWINS_API", "http://localhost:8150/api"),
            "revimage": os.getenv("REVIMAGE_API", "http://localhost:8610/api"),
            "revpublish": os.getenv("REVPUBLISH_API", "http://localhost:8550/api"),
            "revmetrics": os.getenv("REVMETRICS_API", "http://localhost:8220/api"),
            "revsignal": os.getenv("REVSIGNAL_API", "http://localhost:8006/api"),
            "revintel": os.getenv("REVINTEL_API", "http://localhost:8011/api"),
            "revdispatch": os.getenv("REVDISPATCH_API", "http://localhost:8501/api"),
            "revvest": os.getenv("REVVEST_API", "http://localhost:8003/api"),
            "revspy": os.getenv("REVSPY_API", "http://localhost:8160/api"),
            "revspend": os.getenv("REVSPEND_API", "http://localhost:8105/api"),
            "revcore": os.getenv("REVCORE_API", "http://localhost:8004/api"),
            "revassist": os.getenv("REVASSIST_API", "http://localhost:8100/api"),
        }
        
        self.timeout = float(os.getenv("REVFLOW_REQUEST_TIMEOUT", "30"))
    
    def call_module(
        self,
        module_name: str,
        endpoint: str,
        method: str = "GET",
        data: Optional[Dict] = None,
        use_gateway: Optional[bool] = None,
    ) -> Dict[Any, Any]:
        """
        Call any module - tries gateway first, falls back to direct
        
        Args:
            module_name: "revspy", "revrank", "revpublish", etc.
            endpoint: "/serp-analysis", "/generate", etc.
            method: "GET", "POST", "PUT", "DELETE"
            data: Request body for POST/PUT
            use_gateway: Override default gateway preference (optional)
        
        Returns:
            Response JSON
        
        Raises:
            requests.exceptions.RequestException: If both gateway and direct fail
        """
        
        # Determine which mode to use
        use_gw = use_gateway if use_gateway is not None else self.use_gateway
        
        # Ensure endpoint starts with /
        if not endpoint.startswith("/"):
            endpoint = "/" + endpoint
        
        if use_gw:
            try:
                return self._call_via_gateway(module_name, endpoint, method, data)
            except Exception as e:
                logger.warning(
                    f"Gateway call failed for {module_name}{endpoint}, "
                    f"falling back to direct: {str(e)}"
                )
                return self._call_direct(module_name, endpoint, method, data)
        else:
            return self._call_direct(module_name, endpoint, method, data)
    
    def _call_via_gateway(
        self,
        module_name: str,
        endpoint: str,
        method: str,
        data: Optional[Dict],
    ) -> Dict[Any, Any]:
        """Call module through RevCore gateway"""
        url = f"{self.gateway}/{module_name}{endpoint}"
        
        logger.info(f"[GATEWAY] {method} {url}")
        
        if method == "GET":
            response = requests.get(url, params=data, timeout=self.timeout)
        elif method == "POST":
            response = requests.post(url, json=data, timeout=self.timeout)
        elif method == "PUT":
            response = requests.put(url, json=data, timeout=self.timeout)
        elif method == "DELETE":
            response = requests.delete(url, timeout=self.timeout)
        else:
            raise ValueError(f"Unsupported method: {method}")
        
        response.raise_for_status()
        return response.json()
    
    def _call_direct(
        self,
        module_name: str,
        endpoint: str,
        method: str,
        data: Optional[Dict],
    ) -> Dict[Any, Any]:
        """Call module directly (legacy pattern)"""
        
        if module_name not in self.direct_endpoints:
            raise ValueError(f"Unknown module: {module_name}")
        
        base_url = self.direct_endpoints[module_name]
        url = f"{base_url}{endpoint}"
        
        logger.info(f"[DIRECT] {method} {url}")
        
        if method == "GET":
            response = requests.get(url, params=data, timeout=self.timeout)
        elif method == "POST":
            response = requests.post(url, json=data, timeout=self.timeout)
        elif method == "PUT":
            response = requests.put(url, json=data, timeout=self.timeout)
        elif method == "DELETE":
            response = requests.delete(url, timeout=self.timeout)
        else:
            raise ValueError(f"Unsupported method: {method}")
        
        response.raise_for_status()
        return response.json()


# Singleton pattern for convenient access
_client = None

def get_revflow_client() -> RevFlowClient:
    """Get or create singleton client"""
    global _client
    if _client is None:
        _client = RevFlowClient()
    return _client


# Convenience functions for common modules
def call_revspy(endpoint: str, method: str = "GET", data: dict = None) -> dict:
    return get_revflow_client().call_module("revspy", endpoint, method, data)

def call_revrank(endpoint: str, method: str = "GET", data: dict = None) -> dict:
    return get_revflow_client().call_module("revrank", endpoint, method, data)

def call_revpublish(endpoint: str, method: str = "GET", data: dict = None) -> dict:
    return get_revflow_client().call_module("revpublish", endpoint, method, data)

def call_revcore(endpoint: str, method: str = "GET", data: dict = None) -> dict:
    return get_revflow_client().call_module("revcore", endpoint, method, data)
