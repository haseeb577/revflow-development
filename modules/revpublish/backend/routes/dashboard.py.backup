"""
RevPublish Dashboard API Routes
Matches actual PostgreSQL schema
"""
from fastapi import APIRouter, HTTPException
from typing import List, Optional
import psycopg2
from psycopg2.extras import RealDictCursor
import os

router = APIRouter()

def get_db_connection():
    """Get database connection using environment variables"""
    return psycopg2.connect(
        host=os.getenv("POSTGRES_HOST", "localhost"),
        port=os.getenv("POSTGRES_PORT", "5432"),
        database=os.getenv("POSTGRES_DB", "revflow"),
        user=os.getenv("POSTGRES_USER", "postgres"),
        password=os.getenv("POSTGRES_PASSWORD"),
        cursor_factory=RealDictCursor
    )

@router.get("/dashboard-stats")
async def get_dashboard_stats():
    """Get dashboard overview statistics"""
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        
        # Count sites (actual column: id not site_id)
        cursor.execute("SELECT COUNT(*) FROM revpublish_sites WHERE status = 'active'")
        total_sites = cursor.fetchone()['count']
        
        # Count queue items
        cursor.execute("SELECT COUNT(*) FROM revpublish_content_queue WHERE status = 'pending'")
        queued = cursor.fetchone()['count']
        
        # Count deployments (actual column: deployed_at not published_at)
        cursor.execute("SELECT COUNT(*) FROM revpublish_deployments WHERE deployed_at IS NOT NULL")
        total_deployments = cursor.fetchone()['count']
        
        # Recent deployments (last 7 days)
        cursor.execute("""
            SELECT COUNT(*) 
            FROM revpublish_deployments 
            WHERE deployed_at >= NOW() - INTERVAL '7 days'
        """)
        recent_deployments = cursor.fetchone()['count']
        
        cursor.close()
        conn.close()
        
        return {
            "status": "success",
            "total_sites": total_sites,
            "sites_healthy": total_sites,  # Simplified - all active sites
            "queued_content": queued,
            "total_deployments": total_deployments,
            "deployments_last_7_days": recent_deployments
        }
        
    except Exception as e:
        return {"status": "error", "error": str(e)}

@router.get("/sites")
async def get_sites(page: int = 1, per_page: int = 10):
    """Get paginated list of WordPress sites"""
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        
        offset = (page - 1) * per_page
        
        # Actual columns: id, site_name, site_url, wp_admin_url, status, created_at
        cursor.execute(f"""
            SELECT 
                id,
                site_name,
                site_url,
                wp_admin_url,
                status,
                created_at,
                updated_at
            FROM revpublish_sites
            ORDER BY created_at DESC
            LIMIT {per_page} OFFSET {offset}
        """)
        
        sites = cursor.fetchall()
        
        # Get total count
        cursor.execute("SELECT COUNT(*) FROM revpublish_sites")
        total = cursor.fetchone()['count']
        
        cursor.close()
        conn.close()
        
        return {
            "status": "success",
            "sites": sites,
            "page": page,
            "per_page": per_page,
            "total": total,
            "pages": (total + per_page - 1) // per_page
        }
        
    except Exception as e:
        return {"status": "error", "error": str(e), "sites": []}

@router.get("/sites/{site_id}")
async def get_site_details(site_id: int):
    """Get details for a specific site with recent deployments"""
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        
        # Get site info
        cursor.execute(f"""
            SELECT 
                id,
                site_name,
                site_url,
                wp_admin_url,
                status,
                created_at,
                updated_at
            FROM revpublish_sites
            WHERE id = {site_id}
        """)
        
        site = cursor.fetchone()
        
        if not site:
            cursor.close()
            conn.close()
            raise HTTPException(status_code=404, detail="Site not found")
        
        # Get recent deployments for this site (actual column: deployed_at)
        cursor.execute(f"""
            SELECT 
                d.id,
                d.status,
                d.deployed_at,
                d.created_at,
                q.title as content_title
            FROM revpublish_deployments d
            LEFT JOIN revpublish_content_queue q ON d.content_id = q.id
            WHERE d.site_id = {site_id}
            ORDER BY d.created_at DESC
            LIMIT 10
        """)
        
        deployments = cursor.fetchall()
        
        cursor.close()
        conn.close()
        
        return {
            "status": "success",
            "site": site,
            "recent_deployments": deployments
        }
        
    except HTTPException:
        raise
    except Exception as e:
        return {"status": "error", "error": str(e)}

@router.get("/queue")
async def get_queue(status: Optional[str] = None):
    """Get content queue status"""
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        
        # Build query based on status filter
        query = """
            SELECT 
                q.id,
                q.title as content_title,
                q.source,
                q.status,
                q.created_at,
                q.processed_at,
                q.target_sites
            FROM revpublish_content_queue q
        """
        
        if status:
            query += f" WHERE q.status = '{status}'"
        
        query += " ORDER BY q.created_at DESC LIMIT 50"
        
        cursor.execute(query)
        queue = cursor.fetchall()
        
        cursor.close()
        conn.close()
        
        return {
            "status": "success",
            "queue": queue,
            "count": len(queue)
        }
        
    except Exception as e:
        return {"status": "error", "error": str(e), "queue": []}

@router.get("/deployments")
async def get_deployments(page: int = 1, per_page: int = 20, days: int = 30):
    """Get deployment history"""
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        
        offset = (page - 1) * per_page
        
        # Actual columns: deployed_at (not published_at)
        cursor.execute(f"""
            SELECT 
                d.id,
                d.status,
                d.deployed_at,
                d.created_at,
                d.error_message,
                s.site_name,
                s.site_url,
                q.title as content_title
            FROM revpublish_deployments d
            LEFT JOIN revpublish_sites s ON d.site_id = s.id
            LEFT JOIN revpublish_content_queue q ON d.content_id = q.id
            WHERE d.created_at >= NOW() - INTERVAL '{days} days'
            ORDER BY d.created_at DESC
            LIMIT {per_page} OFFSET {offset}
        """)
        
        deployments = cursor.fetchall()
        
        # Get total count
        cursor.execute(f"""
            SELECT COUNT(*) 
            FROM revpublish_deployments 
            WHERE created_at >= NOW() - INTERVAL '{days} days'
        """)
        total = cursor.fetchone()['count']
        
        cursor.close()
        conn.close()
        
        return {
            "status": "success",
            "deployments": deployments,
            "page": page,
            "per_page": per_page,
            "total": total,
            "pages": (total + per_page - 1) // per_page
        }
        
    except Exception as e:
        return {"status": "error", "error": str(e), "deployments": []}

@router.post("/sites/{site_id}/health-check")
async def trigger_health_check(site_id: int):
    """Trigger health check for a specific site"""
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        
        # Verify site exists
        cursor.execute(f"SELECT id FROM revpublish_sites WHERE id = {site_id}")
        site = cursor.fetchone()
        
        if not site:
            cursor.close()
            conn.close()
            raise HTTPException(status_code=404, detail="Site not found")
        
        # Update updated_at timestamp
        cursor.execute(f"""
            UPDATE revpublish_sites 
            SET updated_at = NOW() 
            WHERE id = {site_id}
        """)
        
        conn.commit()
        cursor.close()
        conn.close()
        
        return {
            "status": "success",
            "message": "Health check triggered",
            "site_id": site_id
        }
        
    except HTTPException:
        raise
    except Exception as e:
        return {"status": "error", "error": str(e)}
